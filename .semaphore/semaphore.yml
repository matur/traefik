version: v1.0
name: Traefik
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
fail_fast:
  stop:
    when: "branch != 'master'"

auto_cancel:
  queued:
    when: "branch != 'master'"
  running:
    when: "branch != 'master'"

global_job_config:
  prologue:
    commands:
      - curl -sSfL https://raw.githubusercontent.com/ldez/semgo/master/godownloader.sh | sudo sh -s -- -b "/usr/local/bin"
      - sudo semgo go1.16
      - export "GOPATH=$(go env GOPATH)"
      - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/traefik/${SEMAPHORE_PROJECT_NAME}"
      - export "PATH=${GOPATH}/bin:${PATH}"
      - mkdir -vp "${SEMAPHORE_GIT_DIR}" "${GOPATH}/bin"
      - export GOPROXY=https://proxy.golang.org,direct
      - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "${GOPATH}/bin" v1.41.1
      - curl -sfL https://install.goreleaser.com/github.com/goreleaser/goreleaser.sh | bash -s -- -b "${GOPATH}/bin"
      - go get -u github.com/containous/go-bindata/...
      - checkout
blocks:
  - name: Test Integration Container
    dependencies: []
    run:
      when: "branch =~ '.*'"
    task:
      jobs:
        - name: Test Integration Container
          commands:
            - make pull-images &
            - mkdir -p static # Avoid to generate webui
            - PRE_TARGET="" make binary
            - make test-integration-container
  - name: Test Integration Host
    dependencies: []
    run:
      when: "branch =~ '.*'"
    task:
      env_vars:
        - name: PRE_TARGET
          value: ""
      jobs:
        - name: Test Integration Host
          commands:
            - mkdir -p static # Avoid to generate webui
            - make test-integration-host
  - name: Release
    dependencies: []
    run:
      when: "tag =~ '.*'"
    task:
      secrets:
        - name: traefik
      env_vars:
        - name: PRE_TARGET
          value: ""
        - name: GH_VERSION
          value: 1.12.1
        - name: CODENAME
          value: "livarot"
      prologue:
        commands:
          - export VERSION=${SEMAPHORE_GIT_TAG_NAME}
          - curl -sSL -o /tmp/gh_${GH_VERSION}_linux_amd64.tar.gz https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz
          - tar -zxvf /tmp/gh_${GH_VERSION}_linux_amd64.tar.gz -C /tmp
          - sudo mv /tmp/gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/gh
          - gh auth login --hostname=github.com
      jobs:
        - name: Release
          commands:
            - make release-packages
        - name: Github release
          commands:
            - gh release create --repo mmatur/traefik --draft --title ${SEMAPHORE_GIT_TAG_NAME} --notes ${SEMAPHORE_GIT_TAG_NAME} ${SEMAPHORE_GIT_TAG_NAME} ./dist/traefik*.tar.gz
        - name: Docker libray image
          commands:
            - ./script/deploy.sh
